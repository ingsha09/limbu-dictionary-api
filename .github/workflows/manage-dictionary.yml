name: ğŸ“– Limbu Dictionary Manager
on:
  push:
    paths:
      - 'data.json'
  workflow_dispatch:

jobs:
  sync-and-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ› ï¸ Process Data (Auto-Format, Clean & Add Months)
        run: |
          node << 'EOF'
          const fs = require('fs');
          const filePath = 'data.json';
          
          try {
            console.log("Reading data.json...");
            let rawContent = fs.readFileSync(filePath, 'utf8');
            let data = JSON.parse(rawContent);
            
            if (!Array.isArray(data)) {
              data = Object.entries(data).map(([id, details]) => ({
                id: id,
                ...details
              }));
            }

            // 1. DEFINE MONTH DATA TO INJECT
            const limbuMonths = [
              { id: "m01", limbu: "á¤á¤ á¤°á¤‘á¤§á¤°á¤˜á¤ ", phonetic: "Kakphekwa", en: "January", ne: "à¤•à¤¾à¤•à¥à¤«à¥‡à¤µà¤¾ (à¤®à¤¾à¤˜)" },
              { id: "m02", limbu: "á¤›á¤ á¤µá¤‘á¤§á¤°á¤˜á¤ ", phonetic: "Sakphekwa", en: "February", ne: "à¤¸à¤¾à¤•à¥à¤«à¥‡à¤µà¤¾ (à¤«à¤¾à¤²à¥à¤—à¥à¤¨)" },
              { id: "m03", limbu: "á¤†á¤§á¤–á¤§á¤±á¤á¤ á¤¶", phonetic: "Cherengnam", en: "March", ne: "à¤šà¥‡à¤°à¥‡à¤™à¥à¤¨à¤¾à¤® (à¤šà¥ˆà¤¤)" },
              { id: "m04", limbu: "á¤Œá¤§á¤–á¤§á¤±á¤á¤ á¤¶", phonetic: "Therenam", en: "April", ne: "à¤¥à¥‡à¤°à¥‡à¤¨à¤¾à¤® (à¤µà¥ˆà¤¶à¤¾à¤–)" },
              { id: "m05", limbu: "á¤á¤ á¤µá¤”á¤£á¤á¤»á¤á¤ ", phonetic: "Kapmeppa", en: "May", ne: "à¤•à¤¾à¤ªà¥à¤®à¥‡à¤ªà¥à¤ªà¤¾ (à¤œà¥‡à¤·à¥à¤ )" },
              { id: "m06", limbu: "á¤Œá¤°á¤”á¤£á¤á¤»á¤á¤ ", phonetic: "Thakmeppa", en: "June", ne: "à¤¥à¤•à¤®à¥‡à¤ªà¥à¤ªà¤¾ (à¤…à¤¸à¤¾à¤°)" },
              { id: "m07", limbu: "á¤›á¤¡á¤›á¤£á¤á¤»á¤á¤ ", phonetic: "Sisekpa", en: "July", ne: "à¤¸à¤¿à¤¸à¥‡à¤•à¥à¤ªà¤¾ (à¤¸à¤¾à¤‰à¤¨)" },
              { id: "m08", limbu: "á¤Œá¤£á¤›á¤£á¤á¤»á¤á¤ ", phonetic: "Thesekpa", en: "August", ne: "à¤ à¥‡à¤¸à¥‡à¤•à¥à¤ªà¤¾ (à¤­à¤¦à¥Œ)" },
              { id: "m09", limbu: "á¤›á¤¡á¤›á¤£á¤á¤»á¤–á¤¥", phonetic: "Sisekkro", en: "September", ne: "à¤¸à¤¿à¤¸à¥‡à¤•à¥à¤•à¥à¤°à¥‹ (à¤…à¤¸à¥‹à¤œ)" },
              { id: "m10", limbu: "á¤Œá¤£á¤›á¤£á¤á¤»á¤–á¤¥", phonetic: "Thesekkro", en: "October", ne: "à¤¥à¥‡à¤¸à¥‡à¤•à¥à¤•à¥à¤°à¥‹ (à¤•à¤¾à¤¤à¥à¤¤à¤¿à¤•)" },
              { id: "m11", limbu: "á¤›á¤§á¤´á¤‡á¤§á¤±á¤—á¤ ", phonetic: "Senchengla", en: "November", ne: "à¤¸à¥‡à¤¨à¥à¤›à¥‡à¤™à¥à¤²à¤¾ (à¤®à¤™à¥à¤¸à¤¿à¤°)" },
              { id: "m12", limbu: "á¤›á¤¡á¤›á¤£á¤á¤»á¤—á¤ ", phonetic: "Sisekla", en: "December", ne: "à¤¸à¤¿à¤¸à¥‡à¤•à¥à¤²à¤¾ (à¤ªà¥à¤¸)" }
            ];

            // 2. CHECK IF MONTHS EXIST, IF NOT ADD THEM
            limbuMonths.forEach(m => {
              if (!data.find(item => item.id === m.id)) {
                data.push({
                  id: m.id,
                  limbu: m.limbu,
                  phonetic: m.phonetic,
                  group: "Months",
                  meaning: { en: m.en, ne: m.ne },
                  status: "verified",
                  lastModified: new Date().toISOString().split('T')[0]
                });
              }
            });

            // 3. CLEAN AND STANDARDIZE ENTRIES
            const processedData = data.map(item => {
              let rawMean = (item.mean || "").replace(/<\/?[^>]+(>|$)/g, "").trim();
              let en = item.meaning?.en || "";
              let ne = item.meaning?.ne || "";

              if (!en && !ne && rawMean) {
                const splitIndex = rawMean.search(/[\u0900-\u097F]/);
                if (splitIndex !== -1) {
                  en = rawMean.substring(0, splitIndex).trim();
                  ne = rawMean.substring(splitIndex).trim();
                } else {
                  en = rawMean;
                }
              }

              return {
                id: (item.id || "new-" + Math.random().toString(36).substr(2, 4)).toString(),
                limbu: (item.limbu || "TBD").trim(),
                phonetic: (item.phonetic || "").trim(),
                group: item.group || "General",
                meaning: {
                  en: en || item.meaning?.en || "No English definition",
                  ne: ne || item.meaning?.ne || "à¤¨à¥‡à¤ªà¤¾à¤²à¥€ à¤…à¤°à¥à¤¥ à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤›à¥ˆà¤¨"
                },
                status: item.status || "verified",
                lastModified: item.lastModified || new Date().toISOString().split('T')[0]
              };
            });

            processedData.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true}));

            fs.writeFileSync(filePath, JSON.stringify(processedData, null, 2));
            console.log("âœ… Success: Dictionary updated with Months and formatted.");
          } catch (err) {
            console.error("âŒ ERROR:", err.message);
            process.exit(1);
          }
          EOF

      - name: ğŸ’¾ Save & Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¤– Auto-Sync: Added Limbu Months to dictionary"
          branch: main
